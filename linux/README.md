# Linux

This usage guide assumes use of a linux distribution with a package manager.

Ensure that you have a Bluetooth 4.0 USB Dongle or built-in hardware for use of Bluetooth Low Energy.

> *The following examples will assume you have an application called blinky.  Replace blinky with your own
application file name.  Additionally, they will use the MAC address 123456abcdef and 
the key 00112233445566778899aabbccddeeff.*

Setup
-----
1. Install python if it is not already installed

    ```sudo apt-get install python27```

2. Install tools for building the image signing application
    
    ```sudo apt-get install build-essential libcrypto++-dev```

3. Build signimage from source Navigate to the signimage folder and run
    
    `make`
    
4. Install the following tools for Bluetooth and Node.js:

    ```sudo apt-get install nodejs node-gyp npm bluetooth bluez-utils libbluetooth-dev```

5. On Ubuntu 12.04, you might need to get a newer nodejs with:

    ```sudo apt-get install python-software-properties
    sudo add-apt-repository ppa:chris-lea/node.js
    sudo apt-get install nodejs```
    
6. Attach a JLink programmer to your machine (either via USB directly with an eval board or your debugger)

Flash the Bootloader and S110 Softdevice 7.1.0
----------------------------------------------

Run the installer script from the:

```flashall.sh 123456abcdef 00112233445566778899aabbccddeeff```
        
> You may need to run with sudo

> flashall.sh can be used anytime you need to completely erase a device and flash only
the bootloader and the softdevice to your module.

Generating Unsigned Application Binaries
----------------------------------------

To generate and unsigned binary, simply use the python script provided (genimage.py).  This script
prepends some information that informs bootloader about the size of the OTA update.  The script
takes in an intel hex file (generated by the Keil or GCC toolchains) and outputs a binary.

    python genimage.py -a blinky.hex -o blinky.bin

Once generated, this file can be used to perform an unsecured OTA update via the installed bootloader.

Generating Signed Application Binaries
--------------------------------------

To generate a signed binary, first following the steps in the previous section.  This step is required
for signed binary images.  Next, run the system approprite signimage executable and provide the key
with which to sign the image.  The private keys for signimage are 128-bit.

    signimage blinky.bin blinky_signed.bin 00112233445566778899aabbccddeeff
    
Installing your application
---------------------------

1. Using a shell, navigate to the ble folder in bootloader-tools

2. Ensure the device you want to update is the only Rigado Bootloader device that is advertising

3. Install all required node modules

    ```npm install```
    
4. Use one of the following to install the OTA update:
  
  ```
  For unsigned binaries:
  sudo node dfu.js path/to/blinky.bin

  For signed binaries:
  sudo node dfu.js path/to/blinky_signed.bin
  ```
  
5. Wait for the update to complete and then verify operation

[Home](https://github.com/rigado/bootloader-tools/)
